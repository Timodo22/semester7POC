stages:
  - build_infra
  - configure_servers

variables:
  TF_IN_AUTOMATION: "true"

# Stap 1: Terraform (Bouw de infrastructuur)
deploy_terraform:
  stage: build_infra
  image:
    name: hashicorp/terraform:light
    entrypoint: [""]
  before_script:
    - cd terraform             # <--- BELANGRIJK: Ga de juiste map in
    - terraform init           # <--- BELANGRIJK: Initialiseer Terraform
  script:
    - terraform apply -auto-approve
    # Verplaats inventory voor de volgende stap
    - mv ../inventory.ini ../inventory.ini || mv inventory.ini ../inventory.ini
  artifacts:
    paths:
      - inventory.ini
      - terraform/terraform.tfstate
  only:
    - main

# Stap 2: Ansible (Software installeren)
configure_ansible:
  stage: configure_servers
  image: willhallonline/ansible:latest
  before_script:
    - mkdir -p ~/.ssh
    - chmod 700 ~/.ssh
    # We lezen de file variabele EN voegen een extra enter toe voor de zekerheid
    - cat "$SSH_PRIVATE_KEY" > ~/.ssh/id_rsa
    - echo "" >> ~/.ssh/id_rsa
    - chmod 600 ~/.ssh/id_rsa
    - export ANSIBLE_HOST_KEY_CHECKING=False
  script:
    - ansible-playbook -i inventory.ini ansible/playbook.yml --private-key ~/.ssh/id_rsa
  dependencies:
    - deploy_terraform
  only:
    - main